name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Starting deployment..."
          cd /home/ubuntu/famflix/FamFlixProject || exit 1
          echo "Pulling latest code..."
          git pull origin main
          echo "Installing dependencies..."
          npm install
          echo "Building application..."
          npm run build
          echo "Setting up environment variables..."
          cp env.production.template .env
          echo "Starting application with PM2..."
          npm install -g pm2
          pm2 delete famflix || true
          pm2 start ecosystem.config.js --env production
          pm2 save
          echo "PM2 status:"
          pm2 status
          echo "PM2 logs:"
          pm2 logs famflix --lines 10 || echo "No logs available"
          echo "Checking if port 5000 is listening:"
          netstat -tlnp | grep :5000 || echo "Port 5000 not listening"
          echo "Deployment completed successfully!" 